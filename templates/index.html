<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Recherche de cartes Pok√©mon</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
  <form id="form-filtres" method="get" action="/">
    <!-- BARRE DE RECHERCHE CENTR√âE EN HAUT -->
    <div style="width:100%; display:flex; justify-content:center; align-items:center; margin: 30px 0 20px 0;">
      <div style="position:relative; width:350px; display:flex;">
        <input id="search-bar" type="text" name="search" autocomplete="off" placeholder="Rechercher un Pok√©mon ou un Trainer..." value="{{ search_query|default('') }}" style="flex:1 1 auto; padding: 10px 14px; border-radius: 6px 0 0 6px; border: 1px solid #888; font-size: 1.1rem; outline:none; background: #fff; color: #222; height:44px; box-sizing:border-box;">
        <button type="submit" style="padding: 0 22px; border-radius: 0 6px 6px 0; background: #4a90e2; color: #fff; border: none; font-size: 1.1rem; cursor: pointer; height:44px; box-sizing:border-box; display:flex; align-items:center;">üîç</button>
        <ul id="autocomplete-list" style="position:absolute; top:100%; left:0; right:0; z-index:10; background:white; border:1px solid #4a90e2; border-top:none; list-style:none; margin:0; padding:0; max-height:220px; overflow-y:auto; display:none; box-shadow:0 4px 16px rgba(0,0,0,0.08); border-radius:0 0 8px 8px;"></ul>
      </div>
    </div>
    <script>
      const searchBar = document.getElementById('search-bar');
      const list = document.getElementById('autocomplete-list');
      searchBar.addEventListener('input', function() {
        const val = this.value.trim();
        if(val.length < 1) { list.style.display = 'none'; list.innerHTML = ''; return; }
        fetch(`/autocomplete?q=${encodeURIComponent(val)}`)
          .then(r => r.json())
          .then(data => {
            list.innerHTML = '';
            if(data.length === 0) { list.style.display = 'none'; return; }
            data.forEach(s => {
              const li = document.createElement('li');
              li.textContent = s;
              li.style.padding = '10px 16px';
              li.style.cursor = 'pointer';
              li.style.color = '#222';
              li.style.background = '#fff';
              li.style.fontSize = '1.05rem';
              li.style.transition = 'background 0.15s';
              li.addEventListener('mouseenter', function() { li.style.background = '#eaf3fc'; });
              li.addEventListener('mouseleave', function() { li.style.background = '#fff'; });
              li.addEventListener('mousedown', function(e) {
                searchBar.value = s;
                list.style.display = 'none';
                document.getElementById('form-filtres').submit();
              });
              list.appendChild(li);
            });
            list.style.display = 'block';
          });
      });
      document.addEventListener('click', function(e) {
        if(!list.contains(e.target) && e.target !== searchBar) {
          list.style.display = 'none';
        }
      });
    </script>
    <div class="container">
      <div class="filtres">
        <details>
          <summary>
            <input type="checkbox" id="select_all_eras">
            ERAS
          </summary>
          <div style="max-height:200px; overflow-y:auto; margin-left:10px; margin-top:5px;">
            {% for era in eras %}
              <div>
                <input type="checkbox" name="era" value="{{ era }}"
                  {% if era in selected_eras %}checked{% endif %}
                  onchange="document.getElementById('form-filtres').submit()">
                <label>{{ era.replace('_', ' ') }}</label>
              </div>
            {% endfor %}
          </div>
        </details>

        <details style="margin-top:10px;">
          <summary>
            <input type="checkbox" id="select_all_series">
            SERIES
          </summary>
          <div style="max-height:200px; overflow-y:auto; margin-left:10px; margin-top:5px;">
            {% for s in series %}
              {% if not selected_eras %}
                <div>
                  <input type="checkbox" name="series" value="{{ s }}"
                    {% if s in selected_series %}checked{% endif %}
                    onchange="document.getElementById('form-filtres').submit()">
                  <label>{{ s }}</label>
                </div>
              {% elif s in allowed_series %}
                <div>
                  <input type="checkbox" name="series" value="{{ s }}"
                    {% if s in selected_series %}checked{% endif %}
                    onchange="document.getElementById('form-filtres').submit()">
                  <label>{{ s }}</label>
                </div>
              {% endif %}
            {% endfor %}
          </div>
        </details>

        <details style="margin-top:10px;">
          <summary>
            <input type="checkbox" id="select_all_decks">
            DECKS
          </summary>
          <div style="max-height:200px; overflow-y:auto; margin-left:10px; margin-top:5px;">
            {% for d in decks %}
              <div>
                <input type="checkbox" name="deck" value="{{ d }}"
                  {% if d in selected_decks %}checked{% endif %}
                  onchange="document.getElementById('form-filtres').submit()">
                <label>{{ d }}</label>
              </div>
            {% endfor %}
          </div>
        </details>

        <h3>RARET√â</h3>
        {% for r in rarities|sort %}
          <div>
            <input type="checkbox" name="rarity" value="{{ r }}"
              {% if r in selected_rarities %}checked{% endif %}
              onchange="document.getElementById('form-filtres').submit()">
            <label>{{ r }}</label>
          </div>
        {% endfor %}
        <h3>TYPE DE CARTE</h3>
        {% for t in types|sort %}
          {% if not t.endswith('-BASE') and t != 'CHARACTERS RARES' %}
            <div>
              <input type="checkbox" name="type" value="{{ t|upper }}"
                {% if t in selected_types %}checked{% endif %}
                onchange="document.getElementById('form-filtres').submit()">
              <label>{{ t }}</label>
            </div>
          {% endif %}
        {% endfor %}
        <h3>STYLE DE CARTE</h3>
        {% for s in styles|sort %}
          {% if s != "BASE" %}
            <div>
              <input type="checkbox" name="style" value="{{ s|upper }}"
                {% if s in selected_styles %}checked{% endif %}
                onclick="toggleSubstyles(this)"
                onchange="document.getElementById('form-filtres').submit()">
              <label>{{ s }}</label>
            </div>
          {% endif %}
        {% endfor %}
        {% if selected_styles or selected_types or selected_rarities %}
        <h3>OPTIONS SUPPL√âMENTAIRES</h3>
        {# Liste des options positives en ordre alphab√©tique #}
        {% set positive_options = [
          ("ALTERNATIVES", "opt_alternative"),
          ("ALTERNATIVES GOLD", "opt_alternative_gold"),
          ("BLACK GOLD", "opt_blackgold"),
          ("BORDER GOLD", "opt_bordergold"),
          ("CHARACTERS RARES", "opt_characters"),
          ("FULL ART", "opt_fullart"),
          ("GOLD", "opt_gold"),
          ("GOLD METAL", "opt_gold_metal"),
          ("MEGA-PRIMO", "opt_megaprimo"),
          ("METAL", "opt_metal"),
          ("PLASMA", "opt_plasma"),
          ("RAINBOW", "opt_rainbow"),
          ("SHINY", "opt_shiny"),
          ("TAG TEAM", "opt_tagteam"),
          ("TRAINERS", "opt_trainers")
        ] %}
        <div style="margin-left:10px; margin-top:5px;">
          {% for label, name in positive_options %}
            <div>
              <input type="checkbox" name="{{ name }}" value="1"
                {% if request.args.get(name) %}checked{% endif %}
                onchange="document.getElementById('form-filtres').submit()">
              <label>{{ label }}</label>
            </div>
          {% endfor %}
          <hr style="border:1px solid #444; margin:10px 0;">
        {# Liste des options n√©gatives en ordre alphab√©tique #}
        {% set negative_options = [
          ("NO ALTERNATIVES", "no_alternative"),
          ("NO ALTERNATIVES GOLD", "no_alternative_gold"),
          ("NO BLACK GOLD", "no_blackgold"),
          ("NO BORDER GOLD", "no_border_gold"),
          ("NO CHARACTERS RARES", "no_characters"),
          ("NO FULL ART", "no_fullart"),
          ("NO GOLD", "no_gold"),
          ("NO GOLD METAL", "no_gold_metal"),
          ("NO MEGA-PRIMO", "no_mega_primo"),
          ("NO METAL", "no_metal"),
          ("NO PLASMA", "no_plasma"),
          ("NO RAINBOW", "no_rainbow"),
          ("NO SHINY", "no_shiny"),
          ("NO TAG TEAM", "no_tagteam"),
          ("NO TRAINERS", "no_trainers")
        ] %}
          {% for label, name in negative_options %}
            <div>
              <input type="checkbox" name="{{ name }}" value="1"
                {% if request.args.get(name) %}checked{% endif %}
                onchange="document.getElementById('form-filtres').submit()">
              <label>{{ label }}</label>
            </div>
          {% endfor %}
        </div>
        {% endif %}
        <!-- Le bouton Filtrer a √©t√© retir√© : soumission automatique √† chaque changement -->
      </div>
      <div class="grille">
        <h4>{{ total_cards }} cartes trouv√©es au total</h4>
        <div id="cards-container">
          {% for chemin in cartes %}
            <div class="carte">
              <img class="miniature" src="{{ url_for('static', filename=chemin) }}" alt="{{ chemin }}">
            </div>
          {% endfor %}
        </div>

        {# Pagination #}
        <div class="pagination-container" style="display: flex; justify-content: center; margin-top: 20px;">
          {# Lien 'Pr√©c√©dent' #}
          {% if current_page > 1 %}
            <a href="?{% for key, vals in request.args.lists() if key != 'page' %}{% for v in vals %}{{ key }}={{ v }}&{% endfor %}{% endfor %}page={{ current_page - 1 }}" class="page-link">&laquo; Pr√©c√©dent</a>
          {% else %}
            <span class="page-link disabled">&laquo; Pr√©c√©dent</span>
          {% endif %}

          {# Num√©ros de pages #}
          {% for p in range(1, total_pages + 1) %}
            {% if p == current_page %}
              <span class="page-link current">{{ p }}</span>
            {% else %}
              <a href="?{% for key, vals in request.args.lists() if key != 'page' %}{% for v in vals %}{{ key }}={{ v }}&{% endfor %}{% endfor %}page={{ p }}" class="page-link">{{ p }}</a>
            {% endif %}
          {% endfor %}

          {# Lien 'Suivant' #}
          {% if current_page < total_pages %}
            <a href="?{% for key, vals in request.args.lists() if key != 'page' %}{% for v in vals %}{{ key }}={{ v }}&{% endfor %}{% endfor %}page={{ current_page + 1 }}" class="page-link">Suivant &raquo;</a>
          {% else %}
            <span class="page-link disabled">Suivant &raquo;</span>
          {% endif %}
        </div>
      </div>
    </div>
    <!-- Champ cach√© pour sous-styles -->
    <input type="hidden" id="hidden_substyles" name="substyles"
      value="{% if selected_substyles %}GOLD:{{ selected_substyles|join(',') }}{% endif %}">
  </form>

  <script src="{{ url_for('static', filename='js/main.js') }}"></script>
</body>
</html>