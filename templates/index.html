<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Recherche de cartes Pokémon</title>
  <style>
    body {
      background-color: #1e1e1e;
      color: #f0f0f0;
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 0;
    }
    .container {
      display: flex;
    }
    .filtres {
      flex: 0 0 300px;
      padding: 15px;
      background-color: #2a2a2a;
      height: 100vh;
      overflow-y: auto;
      box-shadow: 2px 0 5px rgba(0, 0, 0, 0.5);
    }
    .filtres h3 {
      margin-top: 20px;
      margin-bottom: 10px;
      font-size: 1rem;
      border-bottom: 1px solid #444;
      padding-bottom: 5px;
    }
    details {
      margin-bottom: 15px;
      border: 1px solid #444;
      border-radius: 4px;
      background-color: #303030;
      overflow: hidden;
    }
    details > summary {
      background-color: #3b3b3b;
      padding: 8px 12px;
      font-size: 0.95rem;
      cursor: pointer;
      border-radius: 4px;
    }
    details[open] > summary {
      background-color: #4a90e2;
      color: #ffffff;
    }
    details > div {
      background-color: #333;
      max-height: 200px;
      overflow-y: auto;
      padding: 8px 12px;
    }
    /* Custom scrollbar for filter lists */
    details > div::-webkit-scrollbar {
      width: 6px;
    }
    details > div::-webkit-scrollbar-track {
      background: #2a2a2a;
      border-radius: 3px;
    }
    details > div::-webkit-scrollbar-thumb {
      background-color: #4a90e2;
      border-radius: 3px;
    }
    details > div input[type="checkbox"] {
      /* Taille et espacement */
      width: 16px;
      height: 16px;
      margin-right: 10px;
      /* Couleur de l’accent (case cochée) */
      accent-color: #4a90e2;
      /* Bordure fine et arrondie */
      border: 2px solid #666;
      border-radius: 4px;
      /* Curseur et ombre légère */
      cursor: pointer;
      box-shadow: 0 0 2px rgba(0,0,0,0.5);
      /* Suppression du transform superposé */
      transform: none;
    }
    details > div input[type="checkbox"]:checked {
      /* Ajuste la bordure lorsque cochée */
      border-color: #4a90e2;
    }
    details > div label {
      font-size: 0.9rem;
    }
    .grille {
      flex: 1;
      padding: 15px;
      overflow-y: auto;
      height: 100vh;
      background-color: #1f1f1f;
    }
    .grille h4 {
      margin-top: 0;
      margin-bottom: 15px;
      font-size: 1.1rem;
    }
    .grille div {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      grid-gap: 12px;
    }
    .carte {
      position: relative;
    }
    .carte img {
      width: 100%;
      height: auto;
      border: 2px solid #444;
      border-radius: 6px;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .carte img:hover {
      transform: scale(1.05);
      box-shadow: 0 0 15px rgba(74, 144, 226, 0.7);
      cursor: pointer;
    }
    /* Lightbox backdrop (overlay) */
    #lightbox-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background-color: rgba(0, 0, 0, 0.85);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 999;
    }
    #lightbox-overlay img {
      max-width: 90vw;
      max-height: 90vh;
      box-shadow: 0 0 30px rgba(0, 0, 0, 0.7);
      border-radius: 8px;
      transform: scale(0.8);
      transition: transform 0.3s ease;
    }
    #lightbox-overlay.visible {
      display: flex;
    }
    #lightbox-overlay.visible img {
      transform: scale(1);
    }
    /* Pagination links styling */
    .pagination-container .page-link, 
    .pagination-container .page-link:link, 
    .pagination-container .page-link:visited {
      background-color: #444;
      color: #f0f0f0;
      text-decoration: none;
      padding: 6px 10px;
      border-radius: 4px;
      margin: 0 4px;
      font-size: 0.9rem;
    }
    .pagination-container .page-link:hover {
      background-color: #666;
    }
    .pagination-container .page-link.current {
      background-color: #888;
      cursor: default;
    }
    .pagination-container .page-link.disabled {
      background-color: #222;
      color: #666;
      cursor: not-allowed;
    }
  </style>
</head>
<body>
  <form id="form-filtres" method="get" action="/">
    <div class="container">
      <div class="filtres">
        <details>
          <summary>
            <input type="checkbox" id="select_all_eras">
            ERAS
          </summary>
          <div style="max-height:200px; overflow-y:auto; margin-left:10px; margin-top:5px;">
            {% for era in eras %}
              <div>
                <input type="checkbox" name="era" value="{{ era }}"
                  {% if era in selected_eras %}checked{% endif %}
                  onchange="document.getElementById('form-filtres').submit()">
                <label>{{ era.replace('_', ' ') }}</label>
              </div>
            {% endfor %}
          </div>
        </details>

        <details style="margin-top:10px;">
          <summary>
            <input type="checkbox" id="select_all_series">
            SERIES
          </summary>
          <div style="max-height:200px; overflow-y:auto; margin-left:10px; margin-top:5px;">
            {% for s in series %}
              {% if not selected_eras %}
                <div>
                  <input type="checkbox" name="series" value="{{ s }}"
                    {% if s in selected_series %}checked{% endif %}
                    onchange="document.getElementById('form-filtres').submit()">
                  <label>{{ s }}</label>
                </div>
              {% elif s in allowed_series %}
                <div>
                  <input type="checkbox" name="series" value="{{ s }}"
                    {% if s in selected_series %}checked{% endif %}
                    onchange="document.getElementById('form-filtres').submit()">
                  <label>{{ s }}</label>
                </div>
              {% endif %}
            {% endfor %}
          </div>
        </details>

        <details style="margin-top:10px;">
          <summary>
            <input type="checkbox" id="select_all_decks">
            DECKS
          </summary>
          <div style="max-height:200px; overflow-y:auto; margin-left:10px; margin-top:5px;">
            {% for d in decks %}
              <div>
                <input type="checkbox" name="deck" value="{{ d }}"
                  {% if d in selected_decks %}checked{% endif %}
                  onchange="document.getElementById('form-filtres').submit()">
                <label>{{ d }}</label>
              </div>
            {% endfor %}
          </div>
        </details>

        <h3>RARETÉ</h3>
        {% for r in rarities|sort %}
          <div>
            <input type="checkbox" name="rarity" value="{{ r }}"
              {% if r in selected_rarities %}checked{% endif %}
              onchange="document.getElementById('form-filtres').submit()">
            <label>{{ r }}</label>
          </div>
        {% endfor %}
        <h3>TYPE DE CARTE</h3>
        {% for t in types|sort %}
          {% if not t.endswith('-BASE') %}
            <div>
              <input type="checkbox" name="type" value="{{ t }}"
                {% if t in selected_types %}checked{% endif %}
                onchange="document.getElementById('form-filtres').submit()">
              <label>{{ t }}</label>
            </div>
          {% endif %}
        {% endfor %}
        <h3>STYLE DE CARTE</h3>
        {% for s in styles|sort %}
          {% if s != "BASE" %}
            <div>
              <input type="checkbox" name="style" value="{{ s }}"
                {% if s in selected_styles %}checked{% endif %}
                onclick="toggleSubstyles(this)"
                onchange="document.getElementById('form-filtres').submit()">
              <label>{{ s }}</label>
            </div>
          {% endif %}
        {% endfor %}
        {% if selected_styles or selected_types or selected_rarities %}
        <h3>OPTIONS SUPPLÉMENTAIRES</h3>
        {# Liste des options positives en ordre alphabétique #}
        {% set positive_options = [
          ("ALTERNATIVES", "opt_alternative"),
          ("ALTERNATIVES GOLD", "opt_alternative_gold"),
          ("BLACK GOLD", "opt_blackgold"),
          ("BORDER GOLD", "opt_bordergold"),
          ("CHARACTERS RARES", "characters"),
          ("FULL ART", "opt_fullart"),
          ("GOLD", "opt_gold"),
          ("GOLD METAL", "opt_gold_metal"),
          ("MEGA-PRIMO", "opt_megaprimo"),
          ("METAL", "opt_metal"),
          ("RAINBOW", "opt_rainbow"),
          ("SHINY", "opt_shiny"),
          ("TRAINERS", "opt_trainers")
        ] %}
        <div style="margin-left:10px; margin-top:5px;">
          {% for label, name in positive_options %}
            <div>
              <input type="checkbox" name="{{ name }}" value="1"
                {% if request.args.get(name) %}checked{% endif %}
                onchange="document.getElementById('form-filtres').submit()">
              <label>{{ label }}</label>
            </div>
          {% endfor %}
          <hr style="border:1px solid #444; margin:10px 0;">
        {# Liste des options négatives en ordre alphabétique #}
        {% set negative_options = [
          ("NO ALTERNATIVES", "no_alternative"),
          ("NO ALTERNATIVES GOLD", "no_alternative_gold"),
          ("NO BLACK GOLD", "no_blackgold"),
          ("NO BORDER GOLD", "no_border_gold"),
          ("NO CHARACTERS RARES", "no_characters"),
          ("NO FULL ART", "no_fullart"),
          ("NO GOLD", "no_gold"),
          ("NO GOLD METAL", "no_gold_metal"),
          ("NO MEGA-PRIMO", "no_mega_primo"),
          ("NO METAL", "no_metal"),
          ("NO RAINBOW", "no_rainbow"),
          ("NO SHINY", "no_shiny"),
          ("NO TRAINERS", "no_trainers")
        ] %}
          {% for label, name in negative_options %}
            <div>
              <input type="checkbox" name="{{ name }}" value="1"
                {% if request.args.get(name) %}checked{% endif %}
                onchange="document.getElementById('form-filtres').submit()">
              <label>{{ label }}</label>
            </div>
          {% endfor %}
        </div>
        {% endif %}
        <!-- Le bouton Filtrer a été retiré : soumission automatique à chaque changement -->
      </div>
      <div class="grille">
        <h4>{{ total_cards }} cartes trouvées au total</h4>
        <div id="cards-container">
          {% for chemin in cartes %}
            <div class="carte">
              <img class="miniature" src="{{ url_for('static', filename=chemin) }}" alt="{{ chemin }}">
            </div>
          {% endfor %}
        </div>

        {# Pagination #}
        <div class="pagination-container" style="display: flex; justify-content: center; margin-top: 20px;">
          {# Lien 'Précédent' #}
          {% if current_page > 1 %}
            <a href="?{% for key, vals in request.args.lists() if key != 'page' %}{% for v in vals %}{{ key }}={{ v }}&{% endfor %}{% endfor %}page={{ current_page - 1 }}" class="page-link">&laquo; Précédent</a>
          {% else %}
            <span class="page-link disabled">&laquo; Précédent</span>
          {% endif %}

          {# Numéros de pages #}
          {% for p in range(1, total_pages + 1) %}
            {% if p == current_page %}
              <span class="page-link current">{{ p }}</span>
            {% else %}
              <a href="?{% for key, vals in request.args.lists() if key != 'page' %}{% for v in vals %}{{ key }}={{ v }}&{% endfor %}{% endfor %}page={{ p }}" class="page-link">{{ p }}</a>
            {% endif %}
          {% endfor %}

          {# Lien 'Suivant' #}
          {% if current_page < total_pages %}
            <a href="?{% for key, vals in request.args.lists() if key != 'page' %}{% for v in vals %}{{ key }}={{ v }}&{% endfor %}{% endfor %}page={{ current_page + 1 }}" class="page-link">Suivant &raquo;</a>
          {% else %}
            <span class="page-link disabled">Suivant &raquo;</span>
          {% endif %}
        </div>
      </div>
    </div>
    <!-- Champ caché pour sous-styles -->
    <input type="hidden" id="hidden_substyles" name="substyles"
      value="{% if selected_substyles %}GOLD:{{ selected_substyles|join(',') }}{% endif %}">
  </form>

  <script>
    // Affiche/masque les sous-catégories pour "Gold" et "FULL ART"
    function toggleSubstyles(cb) {
      // Existing GOLD handling
      if (cb.value === 'GOLD') {
        let subDiv = document.getElementById('sub-GOLD');
        if (cb.checked) {
          subDiv.style.display = 'block';
        } else {
          subDiv.querySelectorAll('input[type=checkbox]').forEach(i => i.checked = false);
          subDiv.style.display = 'none';
        }
      }
      // Add FULL ART handling
      if (cb.value === 'FULL ART') {
        let subFull = document.getElementById('sub-FULL_ART');
        if (cb.checked) {
          subFull.style.display = 'block';
        } else {
          subFull.querySelectorAll('input[type=checkbox]').forEach(i => i.checked = false);
          subFull.style.display = 'none';
        }
      }
    }

    // Affiche le sous-style GOLD et FULL ART si déjà sélectionné au chargement
    document.addEventListener('DOMContentLoaded', function() {
      // GOLD
      var goldCheckbox = Array.from(document.querySelectorAll('input[name="style"]')).find(cb => cb.value === 'GOLD');
      var subGold = document.getElementById('sub-GOLD');
      if (goldCheckbox && subGold && goldCheckbox.checked) {
        subGold.style.display = 'block';
      } else if (subGold) {
        subGold.style.display = 'none';
      }
      // FULL ART
      var faCheckbox = Array.from(document.querySelectorAll('input[name="style"]')).find(cb => cb.value === 'FULL ART');
      var subFull = document.getElementById('sub-FULL_ART');
      if (faCheckbox && subFull && faCheckbox.checked) {
        subFull.style.display = 'block';
      } else if (subFull) {
        subFull.style.display = 'none';
      }
      // Sélecteur pour ERAS
      var selectAllEras = document.getElementById('select_all_eras');
      if (selectAllEras) {
        selectAllEras.addEventListener('change', function() {
          var eraCheckboxes = document.querySelectorAll('input[name="era"]');
          eraCheckboxes.forEach(function(cb) { cb.checked = selectAllEras.checked; });
          document.getElementById('form-filtres').submit();
        });
        // Synchroniser l'état du select_all_eras au chargement
        var eraCheckboxes = document.querySelectorAll('input[name="era"]');
        if (eraCheckboxes.length > 0) {
          var allChecked = Array.from(eraCheckboxes).every(cb => cb.checked);
          selectAllEras.checked = allChecked;
        }
        // Synchroniser si une case individuelle change (pour décocher "tout sélectionner" si besoin)
        eraCheckboxes.forEach(function(cb) {
          cb.addEventListener('change', function() {
            var allChecked = Array.from(eraCheckboxes).every(c => c.checked);
            selectAllEras.checked = allChecked;
          });
        });
      }

      // --- GÉRER TOUT SÉLECTIONNER POUR SERIES ---
      var selectAllSeries = document.getElementById('select_all_series');
      if (selectAllSeries) {
        selectAllSeries.addEventListener('change', function() {
          var seriesBoxes = document.querySelectorAll('input[name="series"]');
          seriesBoxes.forEach(function(cb) { cb.checked = selectAllSeries.checked; });
          document.getElementById('form-filtres').submit();
        });
        // Synchroniser l'état de select_all_series au chargement
        var seriesBoxes = document.querySelectorAll('input[name="series"]');
        if (seriesBoxes.length > 0) {
          selectAllSeries.checked = Array.from(seriesBoxes).every(cb => cb.checked);
        }
        seriesBoxes.forEach(function(cb) {
          cb.addEventListener('change', function() {
            selectAllSeries.checked = Array.from(seriesBoxes).every(c => c.checked);
          });
        });
      }

      // --- GÉRER TOUT SÉLECTIONNER POUR DECKS ---
      var selectAllDecks = document.getElementById('select_all_decks');
      if (selectAllDecks) {
        selectAllDecks.addEventListener('change', function() {
          var deckBoxes = document.querySelectorAll('input[name="deck"]');
          deckBoxes.forEach(function(cb) { cb.checked = selectAllDecks.checked; });
          document.getElementById('form-filtres').submit();
        });
        // Synchroniser l'état de select_all_decks au chargement
        var deckBoxes = document.querySelectorAll('input[name="deck"]');
        if (deckBoxes.length > 0) {
          selectAllDecks.checked = Array.from(deckBoxes).every(cb => cb.checked);
        }
        deckBoxes.forEach(function(cb) {
          cb.addEventListener('change', function() {
            selectAllDecks.checked = Array.from(deckBoxes).every(c => c.checked);
          });
        });
      }
    });

    // Avant la soumission, on met à jour le champ caché "substyles"
    document.getElementById('form-filtres').addEventListener('submit', function(e) {
      let subChecked = [];
      var subGold = document.getElementById('sub-GOLD');
      if (subGold) {
        subGold.querySelectorAll('input[type=checkbox]').forEach(i => {
          if (i.checked) subChecked.push(i.value);
        });
      }
      let hidden = document.getElementById('hidden_substyles');
      if (subChecked.length > 0) {
        hidden.value = 'GOLD:' + subChecked.join(',');
      } else {
        hidden.value = '';
      }
    });
  </script>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // MEGA-PRIMO vs NO MEGA-PRIMO (Style vs Option négative)
      var styleMega = document.querySelector('input[name="style"][value="MEGA-PRIMO"]');
      var noMega = document.querySelector('input[name="no_mega_primo"]');
      if (styleMega && noMega) {
        styleMega.addEventListener('change', function() { if (styleMega.checked) noMega.checked = false; });
        noMega.addEventListener('change', function() { if (noMega.checked) styleMega.checked = false; });
      }
      // OPTION MEGA-PRIMO vs STYLE MEGA-PRIMO (Option vs Style)
      var optMega = document.querySelector('input[name="opt_megaprimo"]');
      if (optMega && styleMega) {
        optMega.addEventListener('change', function() { if (optMega.checked) styleMega.checked = false; });
        styleMega.addEventListener('change', function() { if (styleMega.checked) optMega.checked = false; });
      }
      // FULL ART vs NO FULL ART (Style vs Option négative)
      var styleFA = document.querySelector('input[name="style"][value="FULL ART"]');
      var noFA = document.querySelector('input[name="no_fullart"]');
      if (styleFA && noFA) {
        styleFA.addEventListener('change', function() {
          if (styleFA.checked) {
            noFA.checked = false;
            document.getElementById('form-filtres').submit();
          }
        });
        noFA.addEventListener('change', function() {
          if (noFA.checked) {
            styleFA.checked = false;
            document.getElementById('form-filtres').submit();
          }
        });
      }
      // OPTION FULL ART vs STYLE FULL ART (Option vs Style)
      var optFA = document.querySelector('input[name="opt_fullart"]');
      if (optFA && styleFA) {
        optFA.addEventListener('change', function() { if (optFA.checked) styleFA.checked = false; });
        styleFA.addEventListener('change', function() { if (styleFA.checked) optFA.checked = false; });
      }
      // BORDER GOLD vs NO BORDER GOLD (Style vs Option négative)
      var styleBG = document.querySelector('input[name="style"][value="BORDER GOLD"]');
      var noBG = document.querySelector('input[name="no_border_gold"]');
      if (styleBG && noBG) {
        styleBG.addEventListener('change', function() { if (styleBG.checked) noBG.checked = false; });
        noBG.addEventListener('change', function() { if (noBG.checked) styleBG.checked = false; });
      }
      // OPTION BORDER GOLD vs STYLE BORDER GOLD (Option vs Style)
      var optBG = document.querySelector('input[name="opt_bordergold"]');
      if (optBG && styleBG) {
        optBG.addEventListener('change', function() { if (optBG.checked) styleBG.checked = false; });
        styleBG.addEventListener('change', function() { if (styleBG.checked) optBG.checked = false; });
      }
    });
  </script>
</body>
  <!-- Lightbox overlay -->
  <div id="lightbox-overlay">
    <img src="" alt="Carte agrandie">
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const overlay = document.getElementById('lightbox-overlay');
      const overlayImg = overlay.querySelector('img');

      document.querySelectorAll('img.miniature').forEach(function(img) {
        img.addEventListener('click', function(event) {
          event.preventDefault();
          overlayImg.src = this.src;
          overlayImg.alt = this.alt || "Carte agrandie";
          overlay.classList.add('visible');
        });
      });

      overlay.addEventListener('click', function(e) {
        if (e.target === overlay) {
          overlay.classList.remove('visible');
          setTimeout(() => { overlayImg.src = ""; }, 300);
        }
      });
    });
  </script>
</html>